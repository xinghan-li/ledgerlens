# 2026-01-20 工作日志

## 项目：LedgerLens - 收据 OCR 后端系统

### 主要成就
今天完成了完整的收据处理 Workflow 系统，实现了 Gemini LLM 集成、统一 OCR 处理、完整的错误处理和 fallback 机制，并建立了统计和监控系统。

---

## 一、核心功能实现

### 1. Google Gemini LLM 集成
**目标**：集成 Google Gemini 作为第二个 LLM 选项，支持多 LLM 提供商

**完成内容**：
- ✅ 安装 `google-generativeai` SDK
- ✅ 配置 `GEMINI_API_KEY` 和 `GEMINI_MODEL` 环境变量
- ✅ 创建 `gemini_client.py` 模块
  - `parse_receipt_with_gemini()`: Gemini API 调用封装
  - 强制 JSON 输出格式（`response_mime_type: "application/json"`）
  - 自动处理 markdown 代码块包裹的 JSON
  - 完善的错误处理和日志记录

- ✅ 更新 `receipt_llm_processor.py`
  - 支持动态 LLM 提供商选择（OpenAI 或 Gemini）
  - 根据环境变量自动选择模型（不再依赖数据库配置）

- ✅ 新增 API 端点
  - `/api/receipt/openai-llm`: OpenAI LLM 处理（重命名自 `/api/receipt/llm-process`）
  - `/api/receipt/gemini-llm`: Gemini LLM 处理

**技术亮点**：
- 环境变量驱动的模型选择，易于扩展新的 LLM 提供商
- 统一的处理接口，两个 LLM 使用相同的 RAG prompt

---

### 2. Gemini 限流管理器
**目标**：管理 Gemini 免费层限制（15份/分钟）

**完成内容**：
- ✅ 创建 `gemini_rate_limiter.py` 模块
  - 使用 UTC 时间，每分钟重置计数器
  - `check_gemini_available()`: 检查是否可用
  - `record_gemini_request()`: 记录请求用于统计
  - 超过限制自动切换到 GPT-4o-mini

**技术亮点**：
- 简单高效的限流机制
- 自动 fallback 到 GPT-4o-mini

---

### 3. 统一 OCR 处理系统
**目标**：标准化不同 OCR 服务的输出格式

**完成内容**：
- ✅ 创建 `ocr_normalizer.py` 模块
  - `normalize_ocr_result()`: 统一标准化函数
  - 支持 Google Document AI、AWS Textract、Google Vision
  - 自动检测 OCR 提供商
  - 统一输出格式：`raw_text`, `entities`, `line_items`, `metadata`

- ✅ 更新 `textract_client.py`
  - 确保输出包含 `metadata.ocr_provider` 字段

**技术亮点**：
- 解耦 OCR 提供商和后续处理逻辑
- 后续处理只需关注统一格式，无需关心 OCR 来源

---

### 4. Sum Check 验证器
**目标**：验证收据数据的数学正确性

**完成内容**：
- ✅ 创建 `sum_checker.py` 模块
  - `check_receipt_sums()`: 验证函数
  - 误差容忍度 ±0.03
  - 处理 null 值（subtotal 为 null 触发 backup check，tax 为 null 视为 0）
  - `apply_field_conflicts_resolution()`: 自动解决 field_conflicts

**验证规则**：
- `sum(line_total) ≈ subtotal`（误差容忍度 ±0.03）
- `subtotal + tax ≈ total`（误差容忍度 ±0.03）

---

### 5. 完整 Workflow 处理系统
**目标**：实现端到端的收据处理流程

**完成内容**：
- ✅ 创建 `workflow_processor.py` 模块
  - `process_receipt_workflow()`: 主处理函数
  - 完整流程：
    1. Google Document AI OCR
    2. 根据 Gemini 限流决定使用 Gemini 还是 GPT-4o-mini
    3. LLM 处理得到结构化 JSON
    4. Sum check
    5. 如果失败，引入 AWS OCR + GPT-4o-mini 二次处理
    6. 文件存储和时间线记录
    7. 统计更新

- ✅ 错误处理和 Fallback 机制
  - Google OCR 失败 → Fallback 到 AWS OCR
  - 第一个 LLM 失败 → Fallback 到另一个 LLM
  - Sum check 失败 → 引入 AWS OCR + GPT-4o-mini 二次处理
  - 所有失败 → 标记为需要人工检查

- ✅ GPT-4o-mini 二次处理
  - `_gpt_backup_processing()`: 使用两个 OCR 结果和第一次 LLM 结果
  - 智能 prompt 设计，要求 GPT 分析错误并修正
  - 在 tbd 字段中详细说明修改内容及原因

- ✅ 新增 API 端点 `/api/receipt/workflow`
  - 接受图片文件上传
  - 返回完整的处理结果和状态

**技术亮点**：
- 完整的错误恢复机制
- 智能的二次处理策略
- 详细的日志和时间线记录

---

### 6. 文件存储系统
**目标**：保存处理结果和调试信息

**完成内容**：
- ✅ 创建输出目录结构
  - `backend/output/`: 成功处理的输出
  - `backend/output/debug/`: 需要人工检查的文件
  - `backend/output/error/`: 错误日志

- ✅ 文件命名规则
  - 格式：`{receipt_id}_{type}.json`
  - receipt_id 格式：`{seq}_{mmyydd_hhmm}`

- ✅ 保存的文件类型
  - 成功：`{receipt_id}_output.json`, `{receipt_id}_timeline.json`
  - Debug：`{receipt_id}_google_ocr.json`, `{receipt_id}_aws_ocr.json`, `{receipt_id}_gemini_llm.json`, `{receipt_id}_gpt_llm.json`, `{receipt_id}_original.jpg`, `{receipt_id}_timeline.json`
  - Error：`{receipt_id}_error.json`, `{receipt_id}_timeline.json`

---

### 7. 时间线记录系统
**目标**：记录处理流程的完整时间线

**完成内容**：
- ✅ 实现 `TimelineRecorder` 类
  - 记录所有关键步骤的开始和结束时间
  - 计算每个步骤的耗时（毫秒）
  - 支持异步操作的时间记录

- ✅ 记录的时间点
  - OCR API 调用开始/结束
  - LLM API 调用开始/结束
  - Sum check 执行时间
  - 文件保存时间

**技术亮点**：
- 完整的性能监控
- 便于识别性能瓶颈

---

### 8. 统计管理系统
**目标**：记录每天 LLM 调用的统计信息

**完成内容**：
- ✅ 创建 `statistics_manager.py` 模块
  - `update_statistics()`: 更新统计信息
  - `get_statistics()`: 获取统计信息
  - 自动计算正确率（sum check 通过数 / 总调用数）

- ✅ 创建数据库表 `llm_statistics`（`006_llm_statistics.sql`）
  - 每天一行记录
  - 记录 Gemini 和 GPT-4o-mini 的调用数、通过数、正确率
  - 记录错误数和人工检查数

**统计指标**：
- Gemini 总调用数、sum check 通过数、正确率
- GPT-4o-mini 总调用数、sum check 通过数、正确率
- 错误数、人工检查数

---

## 二、配置和架构改进

### 1. 环境变量管理优化
**完成内容**：
- ✅ 修复环境变量读取问题
  - 明确指定 `.env` 文件路径（`backend/.env`）
  - 确保 `load_dotenv()` 和 `BaseSettings` 都正确读取
  - 添加调试日志

- ✅ 更新默认模型
  - Gemini 默认模型改为 `gemini-1.5-flash`（免费层可用）
  - 添加模型说明（免费层 vs 付费层）

**优势**：
- 配置集中管理，易于修改
- 支持不同环境使用不同配置

---

### 2. API 端点重构
**完成内容**：
- ✅ 重命名端点
  - `/api/receipt/llm-process` → `/api/receipt/openai-llm`
  
- ✅ 新增端点
  - `/api/receipt/gemini-llm`: Gemini LLM 处理
  - `/api/receipt/workflow`: 完整 workflow 处理

---

## 三、Bug 修复

### 1. 模型名称错误修复
- ✅ 修复 Gemini 使用 OpenAI 模型名称的问题
  - 改为根据 API 端点从环境变量读取对应配置
  - 不再依赖数据库中的 model_name

### 2. 缩进错误修复
- ✅ 修复 `workflow_processor.py` 中的缩进错误

### 3. 环境变量读取修复
- ✅ 修复 `.env` 文件路径问题
- ✅ 确保环境变量正确覆盖默认值

---

## 四、文档和示例

### 1. 创建文档
- ✅ `docs/UNIFIED_OCR_PROCESSING.md`
  - 统一 OCR 处理架构文档
  - 说明不同 OCR 输出的标准化流程

### 2. 创建数据库迁移
- ✅ `006_llm_statistics.sql`: LLM 统计表结构

---

## 五、代码质量改进

### 1. 模块化设计
- ✅ 清晰的职责划分
- ✅ 易于扩展新的 LLM 或 OCR 提供商

### 2. 错误处理
- ✅ 完善的异常处理和日志记录
- ✅ 详细的错误信息

### 3. 类型提示
- ✅ 所有函数添加完整的类型提示

---

## 六、技术债务和 TODO

### 已标记的 TODO
1. ✅ `workflow_processor.py`: 标记未来优化点
   - 批量处理支持
   - 错峰发送给 Gemini
   - 成本优化

---

## 七、测试和验证

### 测试内容
- ✅ 测试 Gemini LLM 集成
- ✅ 测试 Gemini 限流机制
- ✅ 测试统一 OCR 处理
- ✅ 测试完整 Workflow 流程
- ✅ 测试 Sum Check 验证
- ✅ 测试错误处理和 Fallback
- ✅ 测试文件存储和时间线记录
- ✅ 测试统计更新

### 发现的问题
1. **Gemini 模型名称错误**
   - **问题**：使用了 OpenAI 模型名称
   - **解决方案**：改为从环境变量读取，不再依赖数据库

2. **Gemini 免费层限制**
   - **问题**：`gemini-2.0-flash-exp` 不在免费层
   - **解决方案**：改为使用 `gemini-1.5-flash`

3. **环境变量读取问题**
   - **问题**：`.env` 文件路径不正确
   - **解决方案**：明确指定路径，添加调试日志

---

## 八、架构设计决策

### 1. 环境变量驱动的模型选择
**决策**：根据调用的 API 端点从环境变量读取对应的 LLM 配置

**理由**：
- 更简洁，无需判断数据库中的模型名称
- 更易扩展，添加新 LLM 只需添加环境变量和客户端
- 配置集中，所有模型配置在 `.env` 文件中
- 避免混淆，不会出现 Gemini 使用 OpenAI 模型名称的情况

### 2. 统一 OCR 处理
**决策**：创建 OCR Normalizer 标准化不同 OCR 的输出

**理由**：
- 解耦 OCR 提供商和后续处理逻辑
- 后续处理只需关注统一格式
- 易于添加新的 OCR 提供商

### 3. 完整的 Workflow 系统
**决策**：实现端到端的处理流程，包含完整的错误处理和 fallback

**理由**：
- 提高可靠性
- 自动错误恢复
- 详细的日志和监控

---

## 九、文件清单

### 新增文件
1. `backend/app/gemini_client.py` - Gemini LLM 客户端
2. `backend/app/gemini_rate_limiter.py` - Gemini 限流管理器
3. `backend/app/ocr_normalizer.py` - OCR 标准化器
4. `backend/app/sum_checker.py` - Sum Check 验证器
5. `backend/app/workflow_processor.py` - Workflow 处理器
6. `backend/app/statistics_manager.py` - 统计管理器
7. `backend/database/006_llm_statistics.sql` - LLM 统计表
8. `backend/docs/UNIFIED_OCR_PROCESSING.md` - OCR 处理文档

### 修改文件
1. `backend/app/config.py` - 添加 Gemini 配置，修复环境变量读取
2. `backend/app/main.py` - 重命名端点，新增 workflow 端点
3. `backend/app/receipt_llm_processor.py` - 支持动态 LLM 提供商选择
4. `backend/app/textract_client.py` - 添加 metadata 字段
5. `backend/requirements.txt` - 添加 `google-generativeai`

---

## 十、下一步计划

### 阶段 1: 准确率和质量提升（优先级：高）

#### 1.1 过滤模糊小票 ⚠️ **中等**
- 实现图片质量检测
- 使用图像清晰度指标（如 Laplacian 方差）
- 过滤模糊或低质量图片，避免浪费 API 调用
- 工作量：2-3 天

#### 1.2 过滤不是小票的图片 ⚠️ **中等**
- 实现图片分类（收据 vs 非收据）
- 可以使用轻量级模型（如 MobileNet）或规则检测
- 在 OCR 之前过滤，节约成本
- 工作量：2-3 天

#### 1.3 验证精确程度 ⚠️ **高**
- 建立测试数据集
- 对比不同 OCR + LLM 组合的准确率
- 分析错误模式，持续优化
- 工作量：3-5 天

#### 1.4 LLM Prompt 校准 ⚠️ **中等**
- 基于实际测试结果优化 prompt
- 针对不同商店格式调整 prompt 模板
- 工作量：2-3 天

#### 1.5 Python Validator 完善 ⚠️ **中等**
- 用传统方式 validate：
  - Multiset 验证（是否一一对应）
  - 是否 sum to total
  - 有没有重复 items
  - 商品名和价格配对验证
- 工作量：2-3 天

**阶段 1 总计：11-17 天**

---

### 阶段 2: 成本优化（优先级：高）

#### 2.1 想办法节约调模型成本 ⚠️ **高**
- 分析当前成本结构
- 优化 prompt 长度（减少 token 数）
- 实现智能缓存（相同商店的相似收据）
- 批量处理优化
- 工作量：3-5 天

#### 2.2 批量处理与错峰发送 ⚠️ **中等**
- 实现批量处理 API
- 错峰发送给 Gemini（利用免费层限制）
- 实现请求队列和调度系统
- 工作量：3-4 天

**阶段 2 总计：6-9 天**

---

### 阶段 3: 后端核心功能完善（优先级：高）

#### 3.1 用户认证系统 ⚠️ **中等**
- 集成 Supabase Auth（已有表结构）
- JWT token 验证中间件
- 从请求头获取 user_id
- 工作量：2-3 天

#### 3.2 映射表匹配逻辑 ⚠️ **中等**
- 实现 `item_mappings` 表的查询逻辑
- 商品名称标准化和匹配算法
- 工作量：2-3 天

#### 3.3 置信度判断系统 ⚠️ **中等**
- 基于 Document AI confidence 和验证结果
- 标记高/低置信度项目
- 工作量：1-2 天

#### 3.4 轻量级 LLM 调用（低置信度）⚠️ **中等**
- 为低置信度项目调用 LLM + RAG
- 生成建议和备选方案
- 工作量：2-3 天

#### 3.5 数据存储逻辑 ⚠️ **简单**
- 高置信度 → 直接存储
- 低置信度 → `pending_items` 表
- 用户纠正 → `low_confidence_learning` 表
- 工作量：1-2 天

#### 3.6 离线批处理任务 ⚠️ **中等**
- 定期聚合 `low_confidence_learning`
- 模式识别和阈值判断
- 自动提升到 `item_mappings`
- 工作量：3-4 天

**阶段 3 总计：11-17 天**

---

### 阶段 4: 前端开发（优先级：中）

#### 4.1 基础前端框架 ⚠️ **中等**
- React/Next.js 或 Vue/Nuxt 项目搭建
- 路由和基础布局
- 工作量：2-3 天

#### 4.2 用户登录页面 ⚠️ **简单**
- Supabase Auth UI 集成
- 登录/注册/忘记密码
- 工作量：1-2 天

#### 4.3 收据上传页面 ⚠️ **中等**
- 图片上传组件（支持相机）
- 图片压缩（前端）
- 上传进度显示
- 工作量：2-3 天

#### 4.4 收据处理结果页面 ⚠️ **中等**
- 显示解析结果
- 高置信度项目列表
- 低置信度项目卡片（需要用户确认）
- 工作量：3-4 天

#### 4.5 用户确认/纠正界面 ⚠️ **中等**
- **设计用户纠错 UI，矫正一次**
- 低置信度项目编辑表单
- 商品名称/类别/价格修正
- 保存确认
- 工作量：2-3 天

#### 4.6 购买记录列表页面 ⚠️ **中等**
- 收据列表展示
- 筛选和搜索（按日期、商户、金额）
- 分页
- 工作量：2-3 天

#### 4.7 收据详情页面 ⚠️ **简单**
- 显示完整收据信息
- 商品列表
- 图片预览
- 工作量：1-2 天

**阶段 4 总计：13-20 天**

---

### 阶段 5: 历史数据导入（优先级：中）

#### 5.1 批量导入功能 ⚠️ **中等**
- 支持 CSV/JSON 批量导入
- 3 个月历史记录处理
- 数据验证和去重
- 工作量：3-4 天

#### 5.2 导入界面 ⚠️ **简单**
- 文件上传
- 导入进度显示
- 错误报告
- 工作量：1-2 天

**阶段 5 总计：4-6 天**

---

### 阶段 6: 收费机制（优先级：低）

#### 6.1 支付集成 ⚠️ **复杂**
- Stripe/PayPal 集成
- 订阅管理（月度/年度）
- 工作量：4-5 天

#### 6.2 权限控制 ⚠️ **中等**
- 免费用户限制（如 3 个月）
- 付费用户无限制
- 工作量：2-3 天

#### 6.3 计费页面 ⚠️ **简单**
- 定价展示
- 订阅管理
- 工作量：1-2 天

**阶段 6 总计：7-10 天**

---

### 阶段 7: 移动 APP（优先级：低）

#### 7.1 技术选型 ⚠️ **简单**
- React Native / Flutter / 原生
- 工作量：1 天（决策）

#### 7.2 iOS 开发 ⚠️ **复杂**
- 相机集成
- 图片处理
- UI/UX 适配
- App Store 上架
- 工作量：15-20 天

#### 7.3 Android 开发 ⚠️ **复杂**
- 相机集成
- 图片处理
- UI/UX 适配
- Google Play 上架
- 工作量：15-20 天

#### 7.4 跨平台优化 ⚠️ **中等**
- API 集成
- 状态管理
- 离线支持
- 工作量：5-7 天

**阶段 7 总计：36-48 天**

---

## 十一、总结

今天完成了完整的收据处理 Workflow 系统，实现了从 OCR 到 LLM 处理的端到端流程。主要成就包括：

1. **Gemini LLM 集成**：支持多 LLM 提供商，环境变量驱动
2. **统一 OCR 处理**：标准化不同 OCR 输出，解耦后续处理
3. **完整 Workflow**：端到端处理流程，包含完整的错误处理和 fallback
4. **Sum Check 验证**：自动数学验证，确保数据准确性
5. **统计和监控**：完整的性能监控和统计系统
6. **文件存储**：结构化的输出和调试文件管理

**代码行数**：约 2000+ 行新增代码
**数据库迁移**：1 个新 SQL 文件
**新模块**：6 个核心模块
**API 端点**：2 个新端点（gemini-llm, workflow）

**项目进度**：从 35-40% 提升到约 50-55%

**下一步重点**：
1. 过滤模糊小票和不是小票的图片（节约成本）
2. 验证精确程度（建立测试数据集）
3. 成本优化（批量处理、错峰发送）
4. 用户认证系统（解锁所有用户相关功能）

---

*日志生成时间：2026-01-20*
