# Receipt Processing Tests

## ğŸ“– æµ‹è¯•è„šæœ¬ä½¿ç”¨è¯´æ˜

### Quick Start

```bash
# 1. å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆè§ä¸‹é¢ "åˆ›å»ºæµ‹è¯•æ•°æ®" éƒ¨åˆ†ï¼‰

# 2. è¿è¡Œæ‰€æœ‰æµ‹è¯•
python backend/tests/test_receipts.py

# 3. è¿è¡Œå•å¼ å°ç¥¨
python backend/tests/test_receipts.py tnt_1

# 4. æŸ¥çœ‹ç»“æœ
# backend/tests/output/tnt_1_actual.json
```

### è¾“å‡ºè¯´æ˜

æµ‹è¯•è„šæœ¬ä¼šï¼š
1. åŠ è½½ `fixtures/{name}.json` (OCR blocks)
2. è‡ªåŠ¨åŠ è½½å¯¹åº”å•†åº—çš„ configï¼ˆå¦‚ `tnt_supermarket_us.json`ï¼‰
3. è¿è¡Œ pipeline_v2 å¤„ç†
4. è¾“å‡ºåˆ° `output/{name}_actual.json`
5. å¦‚æœæœ‰ `fixtures/{name}_expected.json`ï¼Œä¼šè‡ªåŠ¨å¯¹æ¯”å¹¶æ˜¾ç¤ºå·®å¼‚

æµ‹è¯•ä¼šæ˜¾ç¤ºï¼š
- âœ…/âŒ æ¯ä¸ª item çš„ product_name, line_total, on_sale
- âœ…/âŒ item_sum_check / total_sum_check
- ğŸ“Š è¯¦ç»†çš„ items åˆ—è¡¨å’Œ totals

## Creating Test Fixtures

### æ–¹æ³• 1: è‡ªåŠ¨ä¿å­˜ï¼ˆæ¨èï¼‰

**æ¯æ¬¡è°ƒç”¨ `/api/receipt/initial-parse` API éƒ½ä¼šè‡ªåŠ¨ä¿å­˜æµ‹è¯•æ•°æ®ï¼**

ä¸Šä¼ å°ç¥¨åï¼Œåœ¨ `backend/tests/fixtures/` ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
- æ–‡ä»¶åæ ¼å¼ï¼š`YYYYMMDD_HHMMSS_{counter}.json`
- ä¾‹å¦‚ï¼š`20260205_143022_1.json`ï¼ˆ2026å¹´2æœˆ5æ—¥ 14:30:22 ç¬¬1æ¬¡ï¼‰

åŒ…å«ï¼š
- `chain_id`: è¯†åˆ«çš„å•†åº— ID
- `merchant_name`: å•†åº—åç§°
- `timestamp`: ä¿å­˜æ—¶é—´
- `blocks`: OCR blocks æ•°ç»„ï¼ˆå¯ç›´æ¥ç”¨äºæµ‹è¯•ï¼‰

**ä½¿ç”¨æ­¥éª¤**ï¼š
1. ä¸Šä¼ å°ç¥¨åˆ° API
2. æ£€æŸ¥ `backend/tests/fixtures/` è‡ªåŠ¨ç”Ÿæˆçš„ JSON
3. å¯é€‰ï¼šé‡å‘½åä¸ºæœ‰æ„ä¹‰çš„åå­—ï¼ˆå¦‚ `20260205_143022_1.json` â†’ `tnt_payment_issue.json`ï¼‰
4. è¿è¡Œæµ‹è¯•ï¼š`python backend/tests/test_receipts.py tnt_payment_issue`

### æ–¹æ³• 2: æ‰‹åŠ¨åˆ›å»º (`fixtures/{name}.json`)

å¦‚æœéœ€è¦æ‰‹åŠ¨åˆ›å»ºæˆ–ç¼–è¾‘æµ‹è¯•æ•°æ®ï¼š

```json
{
  "chain_id": "tnt_supermarket_us",
  "blocks": [
    {
      "text": "T&T Supermarket US",
      "x": 0.5230,
      "y": 0.1497,
      "center_x": 0.5230,
      "center_y": 0.1497,
      "width": 0.15,
      "height": 0.012,
      "is_amount": false,
      "amount": null
    },
    ...
  ]
}
```

### 2. Expected Output (`fixtures/{name}_expected.json`) - Optional

For automated comparison:

```json
{
  "success": true,
  "items": [
    {
      "product_name": "HOT FOOD BY WEIGHT",
      "line_total": 1399,
      "quantity": 127,
      "unit_price": 1099,
      "on_sale": false
    }
  ],
  "totals": {
    "subtotal": null,
    "tax": 0,
    "total": 20.49
  },
  "item_sum_check": true,
  "total_sum_check": true
}
```

## Output

Test results are saved to `tests/output/{name}_actual.json` for inspection.

## Test Structure

```
backend/tests/
â”œâ”€â”€ test_receipts.py           # Main test runner
â”œâ”€â”€ README.md                  # This file
â”œâ”€â”€ fixtures/                  # Input test data (auto-generated by API)
â”‚   â”œâ”€â”€ 20260205_143022_1.json    # Auto-saved from API
â”‚   â”œâ”€â”€ 20260205_143145_1.json    # Another receipt
â”‚   â”œâ”€â”€ tnt_1.json                # Renamed for clarity
â”‚   â”œâ”€â”€ tnt_1_expected.json       # Expected output (optional, manual)
â”‚   â””â”€â”€ ...
â””â”€â”€ output/                    # Actual output (auto-created by test script)
    â”œâ”€â”€ tnt_1_actual.json
    â””â”€â”€ ...
```

## ğŸ“‹ Workflow å·¥ä½œæµç¨‹

1. **ä¸Šä¼ å°ç¥¨** â†’ API è‡ªåŠ¨ä¿å­˜åˆ° `fixtures/YYYYMMDD_HHMMSS_{n}.json`
2. **æŸ¥çœ‹è‡ªåŠ¨ä¿å­˜çš„ JSON** â†’ æ£€æŸ¥ blocks æ˜¯å¦æ­£ç¡®
3. **ï¼ˆå¯é€‰ï¼‰é‡å‘½å** â†’ æ”¹æˆæœ‰æ„ä¹‰çš„åå­—ï¼ˆå¦‚ `tnt_issue_1.json`ï¼‰
4. **è¿è¡Œæµ‹è¯•** â†’ `python backend/tests/test_receipts.py tnt_issue_1`
5. **æŸ¥çœ‹è¾“å‡º** â†’ `output/tnt_issue_1_actual.json`
6. **å¯¹æ¯”ç»“æœ** â†’ æ£€æŸ¥ product_name, line_total, quantity ç­‰æ˜¯å¦æ­£ç¡®
7. **ï¼ˆå¯é€‰ï¼‰åˆ›å»º expected** â†’ å¦‚æœç»“æœæ­£ç¡®ï¼Œå¤åˆ¶åˆ° `*_expected.json` ä½œä¸º baseline
