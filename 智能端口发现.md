# 智能端口发现机制

## 🎯 问题

之前遇到的问题：
- 后端可能运行在 8000, 8081, 8082, 8083 或 8084
- 前端 `.env.local` 需要手动更新后端 URL
- 端口不一致导致前端无法连接后端

## ✨ 解决方案

现在实现了**智能端口发现**机制！

### 工作流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 启动后端 (python run_backend.py)                      │
│    ├─ 检测可用端口 (8000-8084)                          │
│    ├─ 绑定到第一个可用端口                              │
│    └─ 写入端口配置到 backend-port.json                  │
│       {                                                  │
│         "port": 8083,                                    │
│         "url": "http://localhost:8083",                  │
│         "docs_url": "http://localhost:8083/docs"         │
│       }                                                  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 启动前端 (npm run dev)                                │
│    ├─ predev 脚本自动运行                                │
│    ├─ 读取 backend-port.json                            │
│    ├─ 更新 .env.local 中的 NEXT_PUBLIC_API_URL          │
│    └─ 启动 Next.js 开发服务器                           │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 前端自动连接到正确的后端端口 ✅                        │
└─────────────────────────────────────────────────────────┘
```

## 📁 相关文件

### 后端
- `backend/run_backend.py` - 启动时写入端口配置
- `backend-port.json` - 端口配置文件（自动生成）

### 前端
- `frontend/update-backend-url.js` - 读取端口配置并更新 .env.local
- `frontend/package.json` - 添加了 `predev` 脚本
- `frontend/.env.local` - 环境变量配置（自动更新）

## 🚀 使用方法

### 方式 1：使用启动脚本（推荐）

```powershell
# 一键启动所有服务
.\start-all.ps1

# 会按顺序：
# 1. 清理残留进程
# 2. 启动后端 → 写入端口配置
# 3. 等待 5 秒
# 4. 启动前端 → 自动读取端口配置
```

### 方式 2：手动启动

```bash
# 1. 先启动后端
cd backend
python run_backend.py
# 看到 "✓ 端口配置已写入" 消息

# 2. 再启动前端（会自动检测后端端口）
cd frontend
npm run dev
# 看到 "📡 检测到后端运行在: http://localhost:8083"
```

## 🔧 手动更新端口配置

如果需要手动触发更新：

```bash
cd frontend
node update-backend-url.js
```

## ⚠️ 注意事项

1. **启动顺序很重要**
   - 必须先启动后端，再启动前端
   - 后端会创建 `backend-port.json`
   - 前端依赖这个文件来获取后端地址

2. **backend-port.json 文件**
   - 这个文件会自动生成
   - 不需要提交到 Git（已加入 .gitignore）
   - 如果手动删除，重启后端会重新生成

3. **前端需要重启才能生效**
   - 修改 `.env.local` 后需要重启前端
   - `npm run dev` 会自动运行 predev 脚本更新配置

## 🎉 优势

- ✅ 自动化：无需手动修改配置文件
- ✅ 灵活：后端可以在任何端口运行
- ✅ 智能：前端自动发现后端地址
- ✅ 可靠：启动前自动验证端口配置

## 🐛 故障排除

### 问题：前端连接到错误的端口

**解决：**
```bash
# 1. 检查 backend-port.json 是否存在
cat backend-port.json

# 2. 手动更新前端配置
cd frontend
node update-backend-url.js

# 3. 重启前端
npm run dev
```

### 问题：backend-port.json 不存在

**解决：**
```bash
# 重启后端，它会自动创建
cd backend
python run_backend.py
```

### 问题：.env.local 没有更新

**解决：**
```bash
# 检查 package.json 是否有 predev 脚本
cat frontend/package.json | grep predev

# 手动运行更新脚本
cd frontend
node update-backend-url.js
```

---

**现在你可以放心启动服务，前端会自动找到后端！** 🎯
